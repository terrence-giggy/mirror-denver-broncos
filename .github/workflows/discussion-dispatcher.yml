name: "Discussion Dispatcher ðŸ’¬ðŸ”„"

on:
  discussion:
    types: [created]
  discussion_comment:
    types: [created]

permissions:
  discussions: write
  issues: write
  contents: write

jobs:
  # AI assessment of source proposals
  assess-source:
    if: |
      github.event_name == 'discussion' &&
      github.event.discussion.category.name == 'Sources'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Assess Source Proposal
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python -m main agent run \
            --mission assess_source \
            --input discussion_number=${{ github.event.discussion.number }} \
            --input repository=${{ github.repository }}
  
  # Curate and approve/reject sources
  curate-source:
    if: |
      github.event_name == 'discussion_comment' &&
      github.event.discussion.category.name == 'Sources' &&
      github.event.comment.user.type != 'Bot' &&
      !contains(github.event.comment.body, '<!-- agent-response -->') &&
      (contains(github.event.comment.body, '/approve-source') || contains(github.event.comment.body, '/reject-source'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Process Source Command
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          python -m main agent run \
            --mission curate_sources \
            --input discussion_number=${{ github.event.discussion.number }} \
            --input repository=${{ github.repository }} \
            --input comment_body="$COMMENT_BODY" \
            --input comment_author="$COMMENT_AUTHOR"
  
  # Handle synthesis objections from Discussions
  synthesis-objection:
    if: |
      github.event_name == 'discussion' &&
      contains(github.event.discussion.body, '<!-- objection:synthesis -->')
    runs-on: ubuntu-latest
    steps:
      - name: Create Objection Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const discussion = context.payload.discussion;
            
            const issueBody = `## Synthesis Objection
            
            **From Discussion:** #${discussion.number}
            **Author:** @${discussion.user.login}
            **Created:** ${discussion.created_at}
            
            ## Original Objection
            
            ${discussion.body}
            
            ---
            
            ## Instructions for @copilot
            
            Please review this objection:
            
            1. **Read the objection** above carefully
            2. **Find the canonical entity** mentioned in \`knowledge-graph/canonical/\`
            3. **Evaluate validity:**
               - Is the objection factually correct?
               - Does the evidence support the requested change?
            4. **Take action:**
               - **If valid:** Update the canonical entity (remove/add alias, fix attributes, etc.)
               - **If invalid:** Explain why the current resolution is correct
            5. **Create PR** with any changes to canonical entities or alias map
            6. **Comment on Discussion** #${discussion.number} with your resolution
            7. **Close this Issue** when complete
            
            ## Guidelines
            
            - **Err on the side of caution**: If uncertain, mark entity with \`"needs_review": true\`
            - **Document reasoning**: Add detailed entry to \`resolution_history\`
            - **Preserve provenance**: Never delete source checksums
            - **Be respectful**: Acknowledge the reporter's contribution
            
            ---
            <!-- objection-discussion:${discussion.number} -->
            <!-- copilot:synthesis-objection -->
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: \`Objection: \${discussion.title}\`,
              body: issueBody,
              labels: ['synthesis-objection', 'copilot']
            });
            
            console.log(\`âœ… Created Issue #\${issue.data.number} for objection from Discussion #\${discussion.number}\`);
            
            // Comment on the Discussion to link back to the Issue
            await github.rest.discussions.createDiscussionComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              discussion_number: discussion.number,
              body: \`Thank you for the objection! Created Issue #\${issue.data.number} for @copilot to review.\`
            });
