name: "Template: Sync from Upstream ðŸ”§ðŸ”„âš™ï¸"

on:
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'Upstream repository (owner/repo format)'
        required: true
        type: string
      upstream_branch:
        description: 'Upstream branch to sync from (leave empty for default)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run - only report changes without applying'
        required: false
        type: boolean
        default: false
      force_sync:
        description: 'Force sync - overwrite local modifications without validation'
        required: false
        type: boolean
        default: false

  repository_dispatch:
    types: [upstream-sync]

  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Block forks
        if: github.event.repository.fork == true
        run: |
          echo "::error::This workflow cannot run on forked repositories"
          exit 1

      - name: Verify upstream repo matches (dispatch only)
        if: github.event_name == 'repository_dispatch'
        run: |
          # Verify upstream repo matches allowed upstream
          PAYLOAD_UPSTREAM="${{ github.event.client_payload.upstream_repo }}"
          ALLOWED_UPSTREAM="${{ vars.UPSTREAM_REPO }}"
          
          if [ -z "$ALLOWED_UPSTREAM" ]; then
            echo "::error::UPSTREAM_REPO variable not configured"
            exit 1
          fi
          
          if [ "$PAYLOAD_UPSTREAM" != "$ALLOWED_UPSTREAM" ]; then
            echo "::error::Upstream repo mismatch: got $PAYLOAD_UPSTREAM, expected $ALLOWED_UPSTREAM"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify dispatch signature
        if: github.event_name == 'repository_dispatch'
        env:
          SYNC_SIGNATURE_SECRET: ${{ secrets.SYNC_SIGNATURE_SECRET }}
        run: |
          # Verify HMAC signature using CLI
          if [ -z "$SYNC_SIGNATURE_SECRET" ]; then
            echo "::error::SYNC_SIGNATURE_SECRET not configured"
            exit 1
          fi
          
          PAYLOAD_SIGNATURE="${{ github.event.client_payload.signature }}"
          if [ -z "$PAYLOAD_SIGNATURE" ]; then
            echo "::error::No signature provided in dispatch payload"
            exit 1
          fi
          
          python -m main verify-dispatch \
            --upstream-repo "${{ github.event.client_payload.upstream_repo }}" \
            --upstream-branch "${{ github.event.client_payload.upstream_branch }}" \
            --timestamp "${{ github.event.client_payload.timestamp }}" \
            --signature "$PAYLOAD_SIGNATURE"

      - name: Determine upstream repository
        id: upstream
        run: |
          # Priority: workflow input > dispatch payload > repository variable > error
          if [ -n "${{ github.event.inputs.upstream_repo }}" ]; then
            echo "repo=${{ github.event.inputs.upstream_repo }}" >> $GITHUB_OUTPUT
            echo "Using upstream from workflow input: ${{ github.event.inputs.upstream_repo }}"
          elif [ -n "${{ github.event.client_payload.upstream_repo }}" ]; then
            echo "repo=${{ github.event.client_payload.upstream_repo }}" >> $GITHUB_OUTPUT
            echo "Using upstream from dispatch payload: ${{ github.event.client_payload.upstream_repo }}"
          elif [ -n "${{ vars.UPSTREAM_REPO }}" ]; then
            echo "repo=${{ vars.UPSTREAM_REPO }}" >> $GITHUB_OUTPUT
            echo "Using upstream from repository variable: ${{ vars.UPSTREAM_REPO }}"
          else
            echo "::error::No upstream repository specified. Set UPSTREAM_REPO variable or provide as input."
            exit 1
          fi

      - name: Determine sync options
        id: options
        run: |
          # Determine branch
          if [ -n "${{ github.event.inputs.upstream_branch }}" ]; then
            echo "branch=${{ github.event.inputs.upstream_branch }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.upstream_branch }}" ]; then
            echo "branch=${{ github.event.client_payload.upstream_branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=" >> $GITHUB_OUTPUT
          fi
          
          # Determine dry run mode
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.client_payload.dry_run }}" == "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
          else
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi
          
          # Determine force sync mode
          # Default to true for repository_dispatch (upstream notifications) and scheduled runs
          if [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "force_sync=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "repository_dispatch" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            echo "force_sync=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.client_payload.force_sync }}" == "true" ]; then
            echo "force_sync=true" >> $GITHUB_OUTPUT
          else
            echo "force_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Run sync
        id: sync
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Build command arguments
          ARGS=(
            "--downstream-repo" "${{ github.repository }}"
            "--upstream-repo" "${{ steps.upstream.outputs.repo }}"
            "--json"
          )
          
          # Add optional upstream branch
          if [ -n "${{ steps.options.outputs.branch }}" ]; then
            ARGS+=("--upstream-branch" "${{ steps.options.outputs.branch }}")
          fi
          
          # Add dry-run flag if enabled
          if [ "${{ steps.options.outputs.dry_run }}" == "true" ]; then
            ARGS+=("--dry-run")
          fi
          
          # Add force flag if enabled
          if [ "${{ steps.options.outputs.force_sync }}" == "true" ]; then
            ARGS+=("--force")
          fi
          
          # Run sync and capture output
          python -m main sync-upstream "${ARGS[@]}" > /tmp/sync_result.json
          
          # Parse results and set outputs
          cat /tmp/sync_result.json
          echo ""
          
          if [ -f /tmp/sync_result.json ]; then
            PR_URL=$(jq -r '.pr_url // ""' /tmp/sync_result.json)
            PR_NUMBER=$(jq -r '.pr_number // ""' /tmp/sync_result.json)
            CHANGES_COUNT=$(jq -r '.changes_count // 0' /tmp/sync_result.json)
            ERROR=$(jq -r '.error // ""' /tmp/sync_result.json)
            
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "changes_count=$CHANGES_COUNT" >> $GITHUB_OUTPUT
            
            if [ -n "$ERROR" ] && [ "$ERROR" != "null" ]; then
              echo "Error: $ERROR"
              exit 1
            fi
          fi

      - name: Create job summary
        run: |
          echo "## ðŸ”„ Upstream Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Repository:** ${{ steps.upstream.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ steps.options.outputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Found:** ${{ steps.sync.outputs.changes_count || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.sync.outputs.pr_url }}" ]; then
            echo "### âœ… Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[${{ steps.sync.outputs.pr_url }}](${{ steps.sync.outputs.pr_url }})" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.options.outputs.dry_run }}" == "true" ]; then
            echo "### â„¹ï¸ Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes were applied. Run without dry_run to create a PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository is already in sync with upstream." >> $GITHUB_STEP_SUMMARY
          fi
