name: "Template: Validate & Auto-Merge Sync PRs ðŸ”§ðŸ”„"

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-auto-merge:
    runs-on: ubuntu-latest
    # Only run on sync PRs from the upstream sync workflow
    if: startsWith(github.head_ref, 'sync/upstream-')
    
    steps:
      - name: Block forks
        if: github.event.repository.fork == true
        run: |
          echo "::error::Auto-merge is disabled for forked repositories"
          exit 1

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate PR file scope
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Run validation and capture output
          python -m main validate-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --json > /tmp/validation.json 2>&1 || true
          
          # Check if validation.json exists and has content
          if [ ! -s /tmp/validation.json ]; then
            echo "::error::Validation command failed to produce output"
            echo "Command output:"
            cat /tmp/validation.json 2>/dev/null || echo "(no output file)"
            exit 1
          fi
          
          # Display the validation result for debugging
          echo "Validation result:"
          cat /tmp/validation.json
          echo ""
          
          # Parse JSON results
          VALID=$(jq -r '.valid' /tmp/validation.json 2>&1)
          REASON=$(jq -r '.reason // "Unknown error"' /tmp/validation.json 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to parse validation JSON"
            echo "Raw content:"
            cat /tmp/validation.json
            exit 1
          fi
          
          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          
          if [ "$VALID" != "true" ]; then
            echo "::error::PR validation failed: $REASON"
            exit 1
          fi
          
          echo "âœ… PR validation passed"

      - name: Verify PR branch and metadata
        id: verify
        run: |
          # Verify branch name pattern
          if [[ ! "${{ github.head_ref }}" =~ ^sync/upstream- ]]; then
            echo "::error::PR branch must match pattern sync/upstream-*"
            exit 1
          fi
          
          # Verify this is not a draft PR
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "PR is a draft - skipping auto-merge"
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if PR is from a fork
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "::error::PRs from forks cannot be auto-merged"
            exit 1
          fi
          
          echo "auto_merge=true" >> $GITHUB_OUTPUT
          echo "âœ… All verification checks passed"

      - name: Approve PR (if possible)
        if: steps.verify.outputs.auto_merge == 'true'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Attempt to approve PR, but don't fail if user can't approve their own PR
          if python -m main approve-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --body "âœ… Automated approval: Upstream sync PR passed all validation checks"; then
            echo "âœ… PR approved successfully"
          else
            echo "âš ï¸ Could not approve PR (may be self-approval or lacking permissions)"
            echo "Auto-merge will proceed without explicit approval"
          fi

      - name: Wait for PR to stabilize
        if: steps.verify.outputs.auto_merge == 'true'
        run: |
          echo "Waiting for PR status to stabilize..."
          sleep 5

      - name: Enable auto-merge
        if: steps.verify.outputs.auto_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Retry logic for enabling auto-merge
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES to enable auto-merge..."
            
            if python -m main enable-auto-merge \
              --repo "${{ github.repository }}" \
              --pr ${{ github.event.pull_request.number }} \
              --merge-method SQUASH; then
              echo "âœ… Auto-merge enabled successfully"
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Failed, waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "::warning::Failed to enable auto-merge after $MAX_RETRIES attempts"
          echo "::warning::PR may need manual merge or will auto-merge once all checks pass"
          exit 0

      - name: Wait for PR to stabilize
        if: steps.verify.outputs.auto_merge == 'true'
        run: |
          echo "Waiting for PR status to stabilize..."
          sleep 5

      - name: Enable auto-merge
        if: steps.verify.outputs.auto_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Retry logic for enabling auto-merge
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES to enable auto-merge..."
            
            if python -m main enable-auto-merge \
              --repo "${{ github.repository }}" \
              --pr ${{ github.event.pull_request.number }} \
              --merge-method SQUASH; then
              echo "âœ… Auto-merge enabled successfully"
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Failed, waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "::warning::Failed to enable auto-merge after $MAX_RETRIES attempts"
          echo "::warning::PR may need manual merge or will auto-merge once all checks pass"
          exit 0

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync PR Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
            echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.verify.outputs.auto_merge }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ¤– Auto-merge enabled - PR will merge when checks pass" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
