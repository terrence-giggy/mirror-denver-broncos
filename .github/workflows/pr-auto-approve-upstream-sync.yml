name: "PR Auto-Approve: Upstream Sync ðŸ”§ðŸ”„"

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-auto-merge:
    runs-on: ubuntu-latest
    # Only run on sync PRs from the upstream sync workflow
    if: startsWith(github.head_ref, 'sync/upstream-')
    
    steps:
      - name: Block forks
        if: github.event.repository.fork == true
        run: |
          echo "::error::Auto-merge is disabled for forked repositories"
          exit 1

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate PR file scope
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Run validation and capture output
          python -m main validate-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --json > /tmp/validation.json 2>&1 || true
          
          # Check if validation.json exists and has content
          if [ ! -s /tmp/validation.json ]; then
            echo "::error::Validation command failed to produce output"
            echo "Command output:"
            cat /tmp/validation.json 2>/dev/null || echo "(no output file)"
            exit 1
          fi
          
          # Display the validation result for debugging
          echo "Validation result:"
          cat /tmp/validation.json
          echo ""
          
          # Parse JSON results
          VALID=$(jq -r '.valid' /tmp/validation.json 2>&1)
          REASON=$(jq -r '.reason // "Unknown error"' /tmp/validation.json 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to parse validation JSON"
            echo "Raw content:"
            cat /tmp/validation.json
            exit 1
          fi
          
          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          
          if [ "$VALID" != "true" ]; then
            echo "::error::PR validation failed: $REASON"
            exit 1
          fi
          
          echo "âœ… PR validation passed"

      - name: Verify PR branch and metadata
        id: verify
        run: |
          # Verify branch name pattern
          if [[ ! "${{ github.head_ref }}" =~ ^sync/upstream- ]]; then
            echo "::error::PR branch must match pattern sync/upstream-*"
            exit 1
          fi
          
          # Verify this is not a draft PR
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "PR is a draft - skipping auto-merge"
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if PR is from a fork
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "::error::PRs from forks cannot be auto-merged"
            exit 1
          fi
          
          echo "auto_merge=true" >> $GITHUB_OUTPUT
          echo "âœ… All verification checks passed"

      - name: Auto-approve PR
        if: steps.verify.outputs.auto_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Check if already approved
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const hasApproval = reviews.data.some(review => 
              review.state === 'APPROVED'
            );
            
            if (!hasApproval) {
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  event: 'APPROVE',
                  body: 'ðŸ¤– Auto-approved: Upstream sync PR passed all validation checks.\n\nâœ… Only synced template files modified\nâœ… All validation checks passed\nâœ… Safe to merge automatically'
                });
                
                console.log(`âœ… Auto-approved PR #${pr.number}`);
              } catch (error) {
                // Expected for self-created PRs
                console.log(`â„¹ï¸ Could not approve (${error.message}) - proceeding with auto-merge anyway`);
              }
            } else {
              console.log(`â­ï¸  PR #${pr.number} already approved`);
            }

      - name: Enable auto-merge
        if: steps.verify.outputs.auto_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            try {
              // Enable auto-merge using GraphQL (required for auto-merge API)
              const mutation = `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(mutation, {
                pullRequestId: pr.node_id
              });
              
              console.log(`âœ… Enabled auto-merge for PR #${pr.number}`);
              console.log('PR will automatically merge once all required checks pass.');
            } catch (error) {
              console.log(`âš ï¸  Could not enable auto-merge: ${error.message}`);
              console.log('This may be expected if auto-merge is already enabled or branch protection requires reviews.');
              // Don't fail the workflow - auto-merge might already be enabled
            }

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync PR Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
            echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.verify.outputs.auto_merge }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ¤– Auto-merge enabled - PR will merge when checks pass" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
