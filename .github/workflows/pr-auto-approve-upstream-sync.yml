name: "PR Auto-Approve: Upstream Sync ðŸ”§ðŸ”„"

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-auto-merge:
    runs-on: ubuntu-latest
    # Only run on sync PRs from the upstream sync workflow
    if: startsWith(github.head_ref, 'sync/upstream-')
    
    steps:
      - name: Verify PR author is authorized
        id: verify_author
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;
            const authorType = pr.user.type;
            
            console.log(`ðŸ‘¤ PR Author: ${author} (${authorType})`);
            
            // Allow GitHub Actions bot (creates upstream sync PRs)
            if (author === 'github-actions[bot]' || authorType === 'Bot') {
              console.log('âœ… Author is GitHub Actions bot');
              core.setOutput('is_authorized', 'true');
              return;
            }
            
            // Check if author has admin permissions (for manual emergency syncs)
            try {
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: author
              });
              
              const level = permission.data.permission;
              console.log(`ðŸ” Author permission level: ${level}`);
              
              if (level === 'admin') {
                console.log('âœ… Author has admin access (manual sync allowed)');
                core.setOutput('is_authorized', 'true');
                return;
              }
            } catch (error) {
              console.log(`âš ï¸  Could not check permissions: ${error.message}`);
            }
            
            console.log('âŒ Author is not authorized for upstream sync auto-approval');
            console.log('   Only GitHub Actions bot or repository admins can create upstream sync PRs');
            core.setOutput('is_authorized', 'false');
            core.setFailed('Unauthorized author for upstream sync PR');
      
      - name: Block forks
        if: steps.verify_author.outputs.is_authorized == 'true' && github.event.repository.fork == true
        run: |
          echo "::error::Auto-merge is disabled for forked repositories"
          exit 1

      - name: Checkout code
        if: steps.verify_author.outputs.is_authorized == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.verify_author.outputs.is_authorized == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
      - name: Install dependencies
        if: steps.verify_author.outputs.is_authorized == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate PR file scope
        if: steps.verify_author.outputs.is_authorized == 'true'
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Run validation and capture output
          python -m main validate-pr \
            --repo "${{ github.repository }}" \
            --pr ${{ github.event.pull_request.number }} \
            --json > /tmp/validation.json 2>&1 || true
          
          # Check if validation.json exists and has content
          if [ ! -s /tmp/validation.json ]; then
            echo "::error::Validation command failed to produce output"
            echo "Command output:"
            cat /tmp/validation.json 2>/dev/null || echo "(no output file)"
            exit 1
          fi
          
          # Display the validation result for debugging
          echo "Validation result:"
          cat /tmp/validation.json
          echo ""
          
          # Parse JSON results
          VALID=$(jq -r '.valid' /tmp/validation.json 2>&1)
          REASON=$(jq -r '.reason // "Unknown error"' /tmp/validation.json 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to parse validation JSON"
            echo "Raw content:"
            cat /tmp/validation.json
            exit 1
          fi
          
          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          
          if [ "$VALID" != "true" ]; then
            echo "::error::PR validation failed: $REASON"
            exit 1
          fi
          
          echo "âœ… PR validation passed"

      - name: Verify PR branch and metadata
        if: steps.verify_author.outputs.is_authorized == 'true'
        id: verify
        run: |
          # Verify branch name pattern
          if [[ ! "${{ github.head_ref }}" =~ ^sync/upstream- ]]; then
            echo "::error::PR branch must match pattern sync/upstream-*"
            exit 1
          fi
          
          # Verify this is not a draft PR
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "PR is a draft - skipping auto-merge"
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if PR is from a fork
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "::error::PRs from forks cannot be auto-merged"
            exit 1
          fi
          
          echo "auto_merge=true" >> $GITHUB_OUTPUT
          echo "âœ… All verification checks passed"

      - name: Auto-approve PR
        if: steps.verify_author.outputs.is_authorized == 'true' && steps.verify.outputs.auto_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Check if already approved
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const hasApproval = reviews.data.some(review => 
              review.state === 'APPROVED'
            );
            
            if (!hasApproval) {
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  event: 'APPROVE',
                  body: 'ðŸ¤– Auto-approved: Upstream sync PR passed all validation checks.\n\nâœ… Only synced template files modified\nâœ… All validation checks passed\nâœ… Safe to merge automatically'
                });
                
                console.log(`âœ… Auto-approved PR #${pr.number}`);
              } catch (error) {
                // Expected for self-created PRs
                console.log(`â„¹ï¸ Could not approve (${error.message}) - proceeding with auto-merge anyway`);
              }
            } else {
              console.log(`â­ï¸  PR #${pr.number} already approved`);
            }

      - name: Merge PR directly
        if: steps.verify_author.outputs.is_authorized == 'true' && steps.verify.outputs.auto_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Check if PR is a draft
            if (pr.draft) {
              core.setFailed(`âŒ Cannot merge: PR #${pr.number} is a draft`);
              return;
            }
            
            // Check if PR is mergeable
            const prDetails = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            if (prDetails.data.mergeable === false) {
              core.setFailed(`âŒ Cannot merge: PR #${pr.number} has conflicts or is not mergeable`);
              return;
            }
            
            if (prDetails.data.merged) {
              console.log(`â­ï¸  PR #${pr.number} is already merged`);
              return;
            }
            
            try {
              // Merge the PR directly using REST API
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: 'ðŸ¤– Auto-merged: Upstream sync passed all validation checks'
              });
              
              if (result.data.merged) {
                console.log(`âœ… Successfully merged PR #${pr.number}`);
                console.log(`   SHA: ${result.data.sha}`);
              } else {
                core.setFailed(`âŒ Merge failed for PR #${pr.number}: ${result.data.message || 'Unknown error'}`);
              }
            } catch (error) {
              const errorMessage = error.message || String(error);
              
              if (errorMessage.includes('draft')) {
                core.setFailed(`âŒ Cannot merge: PR #${pr.number} is a draft`);
              } else if (errorMessage.includes('required status check')) {
                console.log(`â¸ï¸  Waiting for required status checks to pass on PR #${pr.number}`);
                console.log('PR will need to be merged manually or re-triggered after checks pass.');
              } else if (errorMessage.includes('branch protection')) {
                console.log(`âš ï¸  Branch protection may prevent auto-merge: ${errorMessage}`);
                console.log('PR may need manual merge or branch protection rules adjustment.');
              } else {
                core.setFailed(`âŒ Failed to merge PR #${pr.number}: ${errorMessage}`);
              }
            }

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync PR Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
            echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.verify.outputs.auto_merge }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ¤– PR merged automatically" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
