name: "Extraction: Retry Rate Limited"

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:

permissions:
  issues: write

jobs:
  retry:
    runs-on: ubuntu-latest
    
    steps:
      - name: Find and Re-queue Rate Limited Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all issues with extraction-rate-limited label
          gh issue list \
            --repo ${{ github.repository }} \
            --label "extraction-rate-limited" \
            --state open \
            --json number \
            --jq '.[].number' | while read issue_num; do
            
            echo "Re-queuing issue #$issue_num"
            
            # Swap labels to trigger extraction workflow again
            gh issue edit "$issue_num" \
              --remove-label "extraction-rate-limited" \
              --add-label "extraction-queue"
            
            # Space out re-queuing to avoid burst (10s between each)
            sleep 10
          done
          
          echo "Re-queue complete"
