name: "3. Op: Monitor Sources"

# Monitor sources for content changes on a schedule
on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      source_url:
        description: "Optional: Check specific source URL only"
        required: false
        type: string
      force_check:
        description: "Ignore backoff timers and check all sources"
        type: boolean
        default: false

permissions:
  issues: write
  contents: write
  discussions: write

jobs:
  monitor-sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run Monitor Agent
        id: monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          ARGS="--mission monitor_sources"
          
          # Add optional source URL filter
          if [ -n "${{ inputs.source_url }}" ]; then
            ARGS="$ARGS --input source_url=${{ inputs.source_url }}"
          fi
          
          # Add force check flag
          if [ "${{ inputs.force_check }}" = "true" ]; then
            ARGS="$ARGS --input force_check=true"
          fi
          
          python -m main agent run $ARGS
      
      - name: Commit monitoring metadata updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(monitor): update source check metadata [skip ci]"
          file_pattern: "knowledge-graph/sources/*.json"
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
