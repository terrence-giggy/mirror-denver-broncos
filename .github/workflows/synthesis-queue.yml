name: "Synthesis: Run Batch üîÑ"

# Runs LLM-driven entity resolution and creates PRs
# Each run processes up to batch_size entities and creates a PR
# Rate limits trigger retry with exit code 42

on:
  # After extraction completes
  workflow_run:
    workflows: ["Extraction: Batch Run üîÑ‚öôÔ∏è"]
    types: [completed]
    
  # Scheduled daily at 7 AM UTC
  schedule:
    - cron: '0 7 * * *'
    
  # Manual trigger
  workflow_dispatch:
    inputs:
      entity_type:
        description: 'Entity type to process'
        type: choice
        options:
          - Organization
          - Person
          - Concept
        default: 'Organization'
      batch_size:
        description: 'Maximum entities per batch'
        type: number
        default: 10
      model:
        description: 'Model to use'
        type: string
        default: 'gpt-4o-mini'

permissions:
  contents: write
  pull-requests: write

jobs:
  run-synthesis-batch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check pending entities
        run: |
          echo "üìä Scanning knowledge graph for pending entities..."
          ENTITY_TYPE="${{ inputs.entity_type || 'Organization' }}"
          python main.py synthesis pending --entity-type "$ENTITY_TYPE"
      
      - name: Run synthesis batch
        id: synthesis
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Determine arguments
          ENTITY_TYPE="${{ inputs.entity_type || 'Organization' }}"
          BATCH_SIZE="${{ inputs.batch_size || 50 }}"
          MODEL="${{ inputs.model || 'gpt-4o-mini' }}"
          
          echo "üîÑ Starting synthesis batch"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Entity Type: $ENTITY_TYPE"
          echo "Batch Size:  $BATCH_SIZE"
          echo "Model:       $MODEL"
          echo "Repository:  ${{ github.repository }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Run synthesis batch
          python main.py synthesis run-batch \
            --entity-type "$ENTITY_TYPE" \
            --batch-size "$BATCH_SIZE" \
            --model "$MODEL" \
            --repository ${{ github.repository }}
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit with 0 only if rate limited (exit code 42)
          if [ $EXIT_CODE -eq 42 ]; then
            echo "rate_limited=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For non-zero exit codes that aren't rate limit, fail the step
          exit $EXIT_CODE
      
      - name: Handle rate limit
        if: steps.synthesis.outputs.rate_limited == 'true'
        run: |
          echo "‚è∏Ô∏è  Rate limited or retryable error - will retry automatically"
          echo "Waiting 60 seconds before retry..."
          sleep 60
      
      - name: Retry synthesis batch
        if: steps.synthesis.outputs.rate_limited == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          ENTITY_TYPE="${{ inputs.entity_type || 'Organization' }}"
          BATCH_SIZE="${{ inputs.batch_size || 50 }}"
          MODEL="${{ inputs.model || 'gpt-4o-mini' }}"
          
          echo "üîÑ Retrying synthesis batch"
          
          python main.py synthesis run-batch \
            --entity-type "$ENTITY_TYPE" \
            --batch-size "$BATCH_SIZE" \
            --model "$MODEL" \
            --repository ${{ github.repository }}
      
      - name: Report success
        if: success()
        run: |
          echo "‚úÖ Synthesis batch completed successfully"
