name: "Synthesis: Create Batch Issue üìã"

# Creates GitHub Issues for entity resolution
# Copilot will process these Issues to build canonical entities
# IMPORTANT: Only creates ONE issue at a time to prevent merge conflicts

on:
  # After extraction completes
  workflow_run:
    workflows: ["Extraction: Batch Run üîÑ‚öôÔ∏è"]
    types: [completed]
    
  # Scheduled daily at 7 AM UTC
  schedule:
    - cron: '0 7 * * *'
    
  # Manual trigger
  workflow_dispatch:
    inputs:
      entity_type:
        description: 'Entity type to process'
        type: choice
        options:
          - all
          - Person
          - Organization
          - Concept
        default: 'all'
      batch_size:
        description: 'Maximum entities per Issue'
        type: number
        default: 50
      full_rebuild:
        description: 'Full rebuild (reprocess all entities)'
        type: boolean
        default: false
      force:
        description: 'Force creation even if synthesis Issue exists'
        type: boolean
        default: false

permissions:
  issues: write
  contents: read

jobs:
  create-synthesis-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for existing synthesis Issues
        if: inputs.force != true
        id: check_existing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'synthesis-batch',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              console.log(`‚è∏Ô∏è  Found ${issues.data.length} open synthesis-batch Issue(s):`);
              issues.data.forEach(issue => {
                console.log(`  - #${issue.number}: ${issue.title}`);
              });
              core.setOutput('has_open_issues', 'true');
              core.setOutput('open_count', issues.data.length);
            } else {
              console.log('‚úÖ No open synthesis-batch Issues found. Proceeding.');
              core.setOutput('has_open_issues', 'false');
              core.setOutput('open_count', 0);
            }
      
      - name: Skip if existing Issues
        if: steps.check_existing.outputs.has_open_issues == 'true' && inputs.force != true
        run: |
          echo "‚è≠Ô∏è  Skipping synthesis Issue creation - ${{ steps.check_existing.outputs.open_count }} synthesis-batch Issue(s) still open"
          echo "This prevents merge conflicts on alias-map.json and canonical entities."
          echo "Wait for existing Issues to complete, or use force=true to override."
          exit 0
      
      - name: Set up Python
        if: steps.check_existing.outputs.has_open_issues != 'true' || inputs.force == true
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        if: steps.check_existing.outputs.has_open_issues != 'true' || inputs.force == true
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create synthesis Issue
        if: steps.check_existing.outputs.has_open_issues != 'true' || inputs.force == true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Determine arguments
          ENTITY_TYPE="${{ inputs.entity_type || 'all' }}"
          BATCH_SIZE="${{ inputs.batch_size || 50 }}"
          FULL_FLAG=""
          
          if [ "${{ inputs.full_rebuild }}" = "true" ]; then
            FULL_FLAG="--full"
          fi
          
          # Create Issue using CLI
          python main.py synthesis create-issue \
            --repository ${{ github.repository }} \
            --entity-type "$ENTITY_TYPE" \
            --batch-size "$BATCH_SIZE" \
            $FULL_FLAG
