name: "Synthesis: Run Batch üîÑ"

# Runs LLM-driven entity resolution and creates PRs
# Each run processes up to batch_size entities and creates a PR
# Rate limits trigger retry with exit code 42

on:
  # After extraction completes
  workflow_run:
    workflows: ["Extraction: Batch Run üîÑ‚öôÔ∏è"]
    types: [completed]
    
  # Scheduled daily at 7 AM UTC
  schedule:
    - cron: '0 7 * * *'
    
  # Manual trigger
  workflow_dispatch:
    inputs:
      entity_type:
        description: 'Entity type to process'
        type: choice
        options:
          - Organization
          - Person
          - Concept
        default: 'Organization'
      batch_size:
        description: 'Maximum entities per batch'
        type: number
        default: 50
      model:
        description: 'Model to use'
        type: string
        default: 'gpt-4o'

permissions:
  contents: write
  pull-requests: write

jobs:
  run-synthesis-batch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run synthesis batch
        id: synthesis
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Determine arguments
          ENTITY_TYPE="${{ inputs.entity_type || 'Organization' }}"
          BATCH_SIZE="${{ inputs.batch_size || 50 }}"
          MODEL="${{ inputs.model || 'gpt-4o' }}"
          
          # Run synthesis batch
          python main.py synthesis run-batch \
            --entity-type "$ENTITY_TYPE" \
            --batch-size "$BATCH_SIZE" \
            --model "$MODEL" \
            --repository ${{ github.repository }}
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Report success
        if: steps.synthesis.outputs.exit_code == '0'
        run: |
          echo "‚úÖ Synthesis batch completed successfully"
      
      - name: Report failure
        if: steps.synthesis.outputs.exit_code != '0' && steps.synthesis.outputs.exit_code != '42'
        run: |
          echo "‚ùå Synthesis batch failed with exit code ${{ steps.synthesis.outputs.exit_code }}"
          exit 1
