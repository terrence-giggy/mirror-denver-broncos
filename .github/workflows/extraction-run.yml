name: "Extraction: Batch Run ðŸ”„âš™ï¸"

# Event-driven batch extraction workflow
# Triggers when documents are added to evidence/parsed/
# Processes multiple documents per run with rate limit resilience
# Uses persistent PR branch extraction/queue, auto-merges when clean

on:
  push:
    branches: [main]
    paths:
      - 'evidence/parsed/**'
      - 'evidence/parsed/manifest.json'
  
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of documents to process'
        required: false
        type: number
        default: 10
      retry_after_rate_limit:
        description: 'Retry after rate limit (true/false)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: extraction-run
  cancel-in-progress: false  # Queue runs, don't cancel

jobs:
  batch-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ensure PR branch exists
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Check if extraction/queue branch exists
          if ! git ls-remote --heads origin extraction/queue | grep extraction/queue; then
            echo "Creating extraction/queue branch from main"
            git checkout -b extraction/queue
            git push origin extraction/queue
            
            # Create PR
            gh pr create \
              --title "Entity Extractions (Batch)" \
              --body "Automated entity extraction from documents in evidence/parsed/. This PR accumulates extractions across multiple workflow runs and auto-merges when all pending documents are processed." \
              --base main \
              --head extraction/queue
          else
            echo "Branch extraction/queue already exists"
          fi
      
      - name: Run batch extraction
        id: extraction
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set +e  # Don't exit on non-zero
          
          python main.py extraction-batch run \
            --batch-size ${{ inputs.batch_size || 10 }} \
            --repository ${{ github.repository }} \
            --token ${{ secrets.GH_TOKEN }}
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE
      
      - name: Handle rate limit
        if: steps.extraction.outputs.exit_code == '42'
        run: |
          echo "Rate limit encountered. Will retry after delay."
          echo "Exit code 42 detected - partial progress has been saved."
      
      - name: Schedule retry after rate limit
        if: steps.extraction.outputs.exit_code == '42'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          event-type: extraction-retry
          client-payload: '{"batch_size": "${{ inputs.batch_size || 10 }}"}'
      
      - name: Check pending documents
        if: steps.extraction.outputs.exit_code == '0'
        id: pending
        run: |
          PENDING=$(python main.py extraction-batch pending --count-only)
          echo "pending_count=$PENDING" >> $GITHUB_OUTPUT
          echo "Pending documents: $PENDING"
      
      - name: Auto-merge PR if clean
        if: steps.extraction.outputs.exit_code == '0' && steps.pending.outputs.pending_count == '0'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "All pending documents processed. Auto-merging PR."
          
          # Get PR number for extraction/queue branch
          PR_NUMBER=$(gh pr list --head extraction/queue --json number -q '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"
            
            # Enable auto-merge with squash strategy
            gh pr merge $PR_NUMBER --auto --squash
            
            echo "Auto-merge enabled for PR #$PR_NUMBER"
          else
            echo "No PR found for extraction/queue branch"
          fi
      
      - name: Delete branch after merge
        if: steps.extraction.outputs.exit_code == '0' && steps.pending.outputs.pending_count == '0'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Wait a bit for merge to complete
          sleep 15
          
          # Check if branch still exists (won't exist if PR merged)
          if git ls-remote --heads origin extraction/queue | grep extraction/queue; then
            echo "Branch still exists, merge may not be complete yet"
          else
            echo "Branch deleted (merge completed successfully)"
          fi

  # Retry workflow after 30 minutes if rate limited
  schedule-retry:
    runs-on: ubuntu-latest
    needs: batch-extraction
    if: needs.batch-extraction.result == 'failure' && github.event.action == 'extraction-retry'
    
    steps:
      - name: Wait for rate limit reset
        run: |
          echo "Waiting 30 minutes for rate limit reset..."
          sleep 1800  # 30 minutes
      
      - name: Trigger retry
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          event-type: extraction-run
          client-payload: '{"batch_size": "${{ github.event.client_payload.batch_size }}", "retry_after_rate_limit": "true"}'
