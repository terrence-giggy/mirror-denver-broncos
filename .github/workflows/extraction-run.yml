name: "Extraction: Batch Run ðŸ”„âš™ï¸"

# Event-driven batch extraction workflow
# Triggers when documents are added to evidence/parsed/
# Processes multiple documents per run with rate limit resilience
# Uses persistent PR branch extraction/queue, auto-merges when clean

on:
  push:
    branches: [main]
    paths:
      - 'evidence/parsed/**'
      - 'evidence/parsed/manifest.json'
  
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of documents to process'
        required: false
        type: number
        default: 10
      retry_after_rate_limit:
        description: 'Retry after rate limit (true/false)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: extraction-run
  cancel-in-progress: false  # Queue runs, don't cancel

jobs:
  batch-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ensure extraction branch exists
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Configure git identity for merge commits
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "=== Checking extraction/queue branch ==="
          echo "Current branch: $(git branch --show-current)"
          echo "Remote branches:"
          git ls-remote --heads origin | grep extraction || echo "  (no extraction branches)"
          
          # Fetch all branches
          git fetch origin main
          
          # Check if extraction/queue branch exists remotely
          if ! git ls-remote --heads origin extraction/queue | grep extraction/queue; then
            echo ""
            echo "=== Creating new extraction/queue branch from main ==="
            git checkout -b extraction/queue origin/main
            echo "Created local branch: extraction/queue from origin/main"
            git push origin extraction/queue
            echo "Pushed to remote: origin/extraction/queue"
          else
            echo ""
            echo "=== Checking out existing extraction/queue branch ==="
            git fetch origin extraction/queue
            echo "Fetched latest from origin/extraction/queue"
            git checkout -b extraction/queue origin/extraction/queue
            echo "Checked out local branch tracking origin/extraction/queue"
            
            # Check if branch needs to be updated from main
            echo ""
            echo "Checking if branch needs update from main..."
            git fetch origin main
            
            BEHIND=$(git rev-list --count extraction/queue..origin/main)
            echo "Commits behind origin/main: $BEHIND"
            
            if [ "$BEHIND" -gt 0 ]; then
              echo "Branch is behind main, merging latest changes..."
              git merge origin/main --allow-unrelated-histories --no-edit -m "Merge latest changes from main"
              git push origin extraction/queue
              echo "Branch updated and pushed"
            else
              echo "Branch is up to date with main"
            fi
          fi
          
          echo ""
          echo "Current branch: $(git branch --show-current)"
          echo "Latest commit: $(git log -1 --oneline)"
      
      - name: Run batch extraction
        id: extraction
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: extraction/queue  # Override to commit to extraction/queue branch
        run: |
          set +e  # Don't exit on non-zero
          
          echo "=== Starting batch extraction ==="
          echo "Batch size: ${{ inputs.batch_size || 10 }}"
          echo "Repository: ${{ github.repository }}"
          echo "Current branch: $(git branch --show-current)"
          echo "GITHUB_REF_NAME environment variable: $GITHUB_REF_NAME"
          echo ""
          
          # Verify environment is correctly set for Python
          export GITHUB_REF_NAME=extraction/queue
          echo "Explicitly set GITHUB_REF_NAME to: $GITHUB_REF_NAME"
          echo ""
          
          python main.py extraction-batch run \
            --batch-size ${{ inputs.batch_size || 10 }} \
            --repository ${{ github.repository }} \
            --token ${{ secrets.GH_TOKEN }}
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=== Extraction complete ==="
          echo "Exit code: $EXIT_CODE"
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "Status: SUCCESS"
          elif [ "$EXIT_CODE" -eq 42 ]; then
            echo "Status: RATE LIMITED (will retry)"
          else
            echo "Status: ERROR"
          fi
          
          exit $EXIT_CODE
      
      - name: Ensure PR exists
        if: steps.extraction.outputs.exit_code == '0' || steps.extraction.outputs.exit_code == '42'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "=== Checking for PR ==="
          
          # Fetch latest from remote to ensure we have current state
          echo "Fetching latest from origin/extraction/queue..."
          git fetch origin extraction/queue
          
          # Compare local and remote
          echo ""
          echo "Branch comparison:"
          echo "  Local branch: $(git branch --show-current)"
          echo "  Local HEAD: $(git rev-parse HEAD)"
          echo "  Remote HEAD: $(git rev-parse origin/extraction/queue)"
          
          # Check for commits between main and extraction/queue ON REMOTE
          echo ""
          echo "Checking commits between origin/main and origin/extraction/queue..."
          REMOTE_COMMITS=$(git log origin/main..origin/extraction/queue --oneline | wc -l)
          echo "Commits on origin/extraction/queue ahead of origin/main: $REMOTE_COMMITS"
          
          if [ "$REMOTE_COMMITS" -gt 0 ]; then
            echo "Sample commits:"
            git log origin/main..origin/extraction/queue --oneline -5
          fi
          
          # Check if PR already exists
          echo ""
          PR_NUMBER=$(gh pr list --head extraction/queue --json number -q '.[0].number')
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for extraction/queue branch"
            
            if [ "$REMOTE_COMMITS" -gt 0 ]; then
              echo ""
              echo "=== Creating PR ==="
              echo "Branch: extraction/queue -> main"
              echo "Commits to include: $REMOTE_COMMITS"
              
              gh pr create \
                --title "Entity Extractions (Batch)" \
                --body "Automated entity extraction from documents in evidence/parsed/. This PR accumulates extractions across multiple workflow runs and auto-merges when all pending documents are processed." \
                --base main \
                --head extraction/queue
              echo "PR created successfully"
            else
              echo ""
              echo "âš ï¸ No commits to create PR with - branch is up to date with main"
              echo "This is normal if:"
              echo "  1. Main was recently updated with these commits (e.g., via sync PR)"
              echo "  2. The extraction hasn't created any new commits yet"
              echo "Skipping PR creation."
            fi
          else
            echo "PR #$PR_NUMBER already exists"
            gh pr view $PR_NUMBER --json title,url -q '.title + " - " + .url'
          fi
      
      - name: Handle rate limit
        if: steps.extraction.outputs.exit_code == '42'
        run: |
          echo "Rate limit encountered. Will retry after delay."
          echo "Exit code 42 detected - partial progress has been saved."
      
      - name: Schedule retry after rate limit
        if: steps.extraction.outputs.exit_code == '42'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          event-type: extraction-retry
          client-payload: '{"batch_size": "${{ inputs.batch_size || 10 }}"}'
      
      - name: Check pending documents
        if: steps.extraction.outputs.exit_code == '0'
        id: pending
        run: |
          echo "=== Checking pending documents ==="
          PENDING=$(python main.py extraction-batch pending --count-only)
          echo "pending_count=$PENDING" >> $GITHUB_OUTPUT
          echo "Pending documents: $PENDING"
          
          if [ "$PENDING" -eq 0 ]; then
            echo "âœ“ All documents processed - ready for auto-merge"
          else
            echo "â§— $PENDING documents still pending - keeping PR open"
          fi
      
      - name: Auto-merge PR if clean
        if: steps.extraction.outputs.exit_code == '0' && steps.pending.outputs.pending_count == '0'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "All pending documents processed. Auto-merging PR."
          
          # Get PR number for extraction/queue branch
          PR_NUMBER=$(gh pr list --head extraction/queue --json number -q '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"
            
            # Enable auto-merge with squash strategy
            gh pr merge $PR_NUMBER --auto --squash
            
            echo "Auto-merge enabled for PR #$PR_NUMBER"
          else
            echo "No PR found for extraction/queue branch"
          fi
      
      - name: Delete branch after merge
        if: steps.extraction.outputs.exit_code == '0' && steps.pending.outputs.pending_count == '0'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Wait a bit for merge to complete
          sleep 15
          
          # Check if branch still exists (won't exist if PR merged)
          if git ls-remote --heads origin extraction/queue | grep extraction/queue; then
            echo "Branch still exists, merge may not be complete yet"
          else
            echo "Branch deleted (merge completed successfully)"
          fi

  # Retry workflow after 30 minutes if rate limited
  schedule-retry:
    runs-on: ubuntu-latest
    needs: batch-extraction
    if: needs.batch-extraction.result == 'failure' && github.event.action == 'extraction-retry'
    
    steps:
      - name: Wait for rate limit reset
        run: |
          echo "Waiting 30 minutes for rate limit reset..."
          sleep 1800  # 30 minutes
      
      - name: Trigger retry
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          event-type: extraction-run
          client-payload: '{"batch_size": "${{ github.event.client_payload.batch_size }}", "retry_after_rate_limit": "true"}'
