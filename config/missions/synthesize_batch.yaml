# Mission to resolve entity duplicates via LLM-driven synthesis.

id: synthesize_batch
version: 1
metadata:
  owner: synthesis-agent
  created_at: 2026-01-10
  summary_tooling: llm-synthesis

goal: |
  Resolve raw extracted entity names to canonical entities by deduplicating,
  matching to existing canonical entities, or creating new ones. Save all
  resolutions to the canonical store and create a pull request with changes.

  **CRITICAL: Use the synthesis tools (resolve_entity, save_synthesis_batch) - do NOT manually create JSON files.**

  Process:
  1. Call list_pending_entities for the specified entity_type to get unresolved entities.
  2. Call get_alias_map to load the current alias mappings.
  3. For each pending entity (up to batch_size):
     - Normalize the raw_name (lowercase, strip, collapse spaces)
     - Check if normalized name exists in alias map (if yes → skip, already resolved)
     - **CROSS-TYPE CHECK:** Detect if entity should be in a different type:
       * If entity_type is Concept and name looks like a person (e.g., "Joe Lombardi", "Vance Joseph"), set needs_review=true and add note in reasoning
       * If entity_type is Concept and name looks like an organization (e.g., "Los Angeles Chargers"), set needs_review=true and add note in reasoning
       * Person indicators: proper names with first+last, titles like "Coach", "Director"
       * Org indicators: team names, company names, "LLC", "Inc", "Foundation"
     - Search canonical entities for semantic matches using get_canonical_entity
       * Abbreviations: "Broncos" → "Denver Broncos"
       * Variants: "The Denver Broncos" → "Denver Broncos"
       * Nicknames or alternate spellings
     - **FOR CONCEPTS:** Use get_source_associations tool to retrieve associations for this source_checksum
       * Extract any associations where this concept is the source or target
       * These will be used to populate the associations field in the canonical entity
     - **FOR CONCEPTS:** Call enrich_concept_attributes to get a description/definition for the concept
       * Pass raw_name and source_checksum
       * The tool will read the source document and extract concept meaning
       * This populates the attributes.description field
     - Decide: MATCH to existing canonical_id OR create NEW entity with new canonical_id (slug)
     - Call resolve_entity with your decision:
       * raw_name: the original extracted name
       * entity_type: from mission inputs
       * source_checksum: from pending entity
       * canonical_id: existing ID (if match) or new slug (if new)
       * is_new: true for new entities, false for matches
       * reasoning: explain why (e.g., "Abbreviation of canonical name"). Include cross-type concerns if detected.
       * confidence: 0.0-1.0 (default 0.95, but < 0.8 if cross-type issue detected)
       * needs_review: true if ambiguous or cross-type issue detected
       * **attributes:** for Concepts, include {"description": "..."}  from enrich_concept_attributes
       * **associations:** for any entity, include merged associations from get_source_associations
  4. After processing all entities, call save_synthesis_batch with a unique batch_id.
     This writes files to disk AND returns modified_file_paths array (just file paths, not content).
     **The modified_file_paths array includes BOTH entity files AND alias-map.json.**
  5. Create a branch using create_branch with branch_name from mission inputs.
  6. Commit ALL files using commit_files_batch with the modified_file_paths array from save_synthesis_batch.
     **CRITICAL: Pass the ENTIRE modified_file_paths array. The tool will read files from disk.**
     **The alias-map.json MUST be included in the paths array.**
  7. Create a pull request using create_pull_request.

  Resolution Rules:
  - Abbreviations match full names: "Broncos" → "Denver Broncos"
  - Nicknames match formal names: "AFC" might match "American Football Conference"
  - Ambiguous cases: set needs_review=true, confidence < 0.8
  - Cross-type leakage (person name in concepts): mark for review
  - Confidence < 0.8: set needs_review=true

constraints:
  - Process only the entity_type specified in mission inputs (Person, Organization, or Concept).
  - Do NOT reprocess entities already in alias map (they are resolved).
  - Maximum batch_size entities per run (from mission inputs).
  - Create feature branch from main before committing.
  - "Use commit_files_batch with the modified_file_paths array from save_synthesis_batch - pass paths as-is."
  - "The alias-map.json path MUST be included - it tracks what entities have been resolved."
  - "NEVER manually create JSON files - use resolve_entity and save_synthesis_batch tools."
  - "NEVER use commit_file to write individual entity files - save_synthesis_batch does this."
  - The synthesis tools (resolve_entity, save_synthesis_batch) handle all file I/O automatically.

success_criteria:
  - All pending entities (up to batch_size) are resolved via resolve_entity tool.
  - Batch is saved via save_synthesis_batch tool (this writes files to disk).
  - Feature branch is created with branch_name from mission inputs.
  - "All modified files from save_synthesis_batch output are committed (including alias-map.json)."
  - "The commit MUST include both entity files AND the alias-map.json file."
  - "Pull request is created with title 'Synthesis: Resolve {entity_type} entities (batch {timestamp})'."
  - Pull request body lists how many entities were created vs updated (from save_synthesis_batch output).

max_steps: 100
model: gpt-4o-mini
allowed_tools:
  - list_pending_entities
  - get_canonical_entity
  - get_alias_map
  - get_source_associations
  - enrich_concept_attributes
  - resolve_entity
  - save_synthesis_batch
  - read_file_content
  - create_branch
  - commit_files_batch
  - create_pull_request
requires_approval: false
